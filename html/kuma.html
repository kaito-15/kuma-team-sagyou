<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bear Incident Map</title>

    <!-- MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />

    <!-- Deck.gl -->
    <script src="https://unpkg.com/deck.gl@8.9.35/dist.min.js"></script>

    <!-- Google Fonts: Inter for Clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #1a1a1a;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            color: #e0e0e0;
        }

        #map {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* UI Overlay */
        .overlay {
            position: absolute;
            top: 24px;
            left: 24px;
            z-index: 100;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 800;
            color: #ffffff;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 16px 24px;
            border-radius: 12px;
            pointer-events: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: inline-block;
        }

        .controls {
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .year-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 12px;
        }

        .play-btn {
            background: #ffffff;
            border: none;
            color: #000000;
            padding: 8px 16px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 13px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .play-btn:hover {
            background: #e0e0e0;
        }

        input[type=range] {
            flex-grow: 1;
            accent-color: #ffffff;
            height: 4px;
            background: #444;
            border-radius: 2px;
            outline: none;
        }

        #current-year {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            min-width: 45px;
            text-align: right;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 12px;
            margin-top: 12px;
        }

        .stat-label {
            font-size: 12px;
            color: #aaa;
            font-weight: 500;
        }

        .stat-value {
            font-size: 18px;
            color: #fff;
            font-weight: 600;
        }

        /* Data Table */
        .data-panel {
            position: absolute;
            top: 24px;
            right: 24px;
            bottom: 24px;
            width: 300px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            z-index: 100;
            overflow-y: auto;
            pointer-events: auto;
            padding: 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .data-panel-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            position: sticky;
            top: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th,
        td {
            text-align: left;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        th {
            color: #888;
            font-size: 11px;
            font-weight: 500;
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .count-high {
            color: #ff4d4d;
            font-weight: 600;
        }

        .count-med {
            color: #ffad33;
        }

        .count-low {
            color: #e0e0e0;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Tooltip */
        .deck-tooltip {
            font-family: 'Inter', sans-serif !important;
            background: rgba(0, 0, 0, 0.8) !important;
            border: none !important;
            color: #fff !important;
            border-radius: 6px !important;
            padding: 8px 12px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        }
    </style>
</head>

<body>

    <div class="overlay">
        <h1>Bear Incident Map</h1>
        <div class="controls">
            <div class="year-selector">
                <button id="play-btn" class="play-btn">Play</button>
                <input type="range" id="year-slider" min="2008" max="2025" step="1" value="2023">
                <span id="current-year">2023</span>
            </div>
            <div class="stats-row">
                <span class="stat-label">Total Incidents</span>
                <span id="total-incidents" class="stat-value">0</span>
            </div>
            <div class="stats-row" style="margin-top: 15px;">
                <span class="stat-label">Speed</span>
                <input type="range" id="speed-slider" min="1" max="20" step="1" value="13" style="width: 100px;">
                <span id="speed-label" class="stat-label"
                    style="color: #fff; min-width: 40px; text-align: right;">1.0x</span>
            </div>
        </div>
    </div>

    <div class="data-panel">
        <div class="data-panel-header">Regional Data</div>
        <table>
            <thead>
                <tr>
                    <th>Prefecture</th>
                    <th>Count</th>
                </tr>
            </thead>
            <tbody id="data-table-body">
                <!-- Rows will be populated by JS -->
            </tbody>
        </table>
    </div>

    <div id="map"></div>

    <script>
        // --- Data ---
        const prefCoords = {
            "北海道": [142.5, 43.5], "青森": [140.74, 40.824], "岩手": [141.153, 39.704], "宮城": [140.872, 38.269],
            "秋田": [140.103, 39.719], "山形": [140.363, 38.241], "福島": [140.468, 37.75], "茨城": [140.447, 36.341],
            "栃木": [139.884, 36.566], "群馬": [139.061, 36.391], "埼玉": [139.649, 35.857], "千葉": [140.123, 35.605],
            "東京": [139.692, 35.689], "神奈川": [139.643, 35.448], "新潟": [139.024, 37.902], "富山": [137.211, 36.695],
            "石川": [136.626, 36.594], "福井": [136.222, 36.065], "山梨": [138.568, 35.664], "長野": [138.181, 36.651],
            "岐阜": [136.722, 35.391], "静岡": [138.383, 34.977], "愛知": [136.907, 35.18], "三重": [136.509, 34.73],
            "滋賀": [135.868, 35.004], "京都": [135.756, 35.021], "大阪": [135.52, 34.686], "兵庫": [135.183, 34.691],
            "奈良": [135.833, 34.685], "和歌山": [135.168, 34.226], "鳥取": [134.238, 35.504], "島根": [133.051, 35.472],
            "岡山": [133.935, 34.662], "広島": [132.459, 34.396], "山口": [131.471, 34.186], "徳島": [134.559, 34.066],
            "香川": [134.043, 34.34], "愛媛": [132.766, 33.842], "高知": [133.531, 33.56], "福岡": [130.418, 33.606],
            "佐賀": [130.299, 33.249], "長崎": [129.874, 32.745], "熊本": [130.742, 32.79], "大分": [131.613, 33.238],
            "宮崎": [131.424, 31.911], "鹿児島": [130.558, 31.56], "沖縄": [127.681, 26.213]
        };

        const rawCsvData = `prefecture,year,bear_killed_count
北海道,2008,351
青森,2008,47
岩手,2008,86
宮城,2008,46
秋田,2008,46
山形,2008,142
福島,2008,111
茨城,2008,0
栃木,2008,24
群馬,2008,75
埼玉,2008,6
千葉,2008,0
東京,2008,1
神奈川,2008,0
新潟,2008,101
富山,2008,37
石川,2008,38
福井,2008,4
山梨,2008,23
長野,2008,121
岐阜,2008,30
静岡,2008,17
愛知,2008,0
三重,2008,0
滋賀,2008,0
京都,2008,8
大阪,2008,0
兵庫,2008,3
奈良,2008,0
和歌山,2008,0
鳥取,2008,1
島根,2008,13
岡山,2008,0
広島,2008,38
山口,2008,1
計,2008,1370
北海道,2009,606
青森,2009,61
岩手,2009,127
宮城,2009,35
秋田,2009,200
山形,2009,109
福島,2009,64
茨城,2009,0
栃木,2009,11
群馬,2009,70
埼玉,2009,6
千葉,2009,0
東京,2009,0
神奈川,2009,0
新潟,2009,67
富山,2009,15
石川,2009,18
福井,2009,5
山梨,2009,21
長野,2009,97
岐阜,2009,46
静岡,2009,16
愛知,2009,1
三重,2009,0
滋賀,2009,0
京都,2009,4
大阪,2009,0
兵庫,2009,2
奈良,2009,0
和歌山,2009,0
鳥取,2009,0
島根,2009,1
岡山,2009,0
広島,2009,2
山口,2009,0
計,2009,1584
北海道,2010,470
青森,2010,66
岩手,2010,149
宮城,2010,72
秋田,2010,241
山形,2010,213
福島,2010,298
茨城,2010,0
栃木,2010,51
群馬,2010,232
埼玉,2010,11
千葉,2010,0
東京,2010,2
神奈川,2010,0
新潟,2010,425
富山,2010,186
石川,2010,75
福井,2010,63
山梨,2010,29
長野,2010,361
岐阜,2010,231
静岡,2010,18
愛知,2010,5
三重,2010,0
滋賀,2010,9
京都,2010,54
大阪,2010,0
兵庫,2010,69
奈良,2010,0
和歌山,2010,0
鳥取,2010,38
島根,2010,49
岡山,2010,0
広島,2010,105
山口,2010,22
計,2010,3544
北海道,2011,692
青森,2011,54
岩手,2011,92
宮城,2011,23
秋田,2011,216
山形,2011,109
福島,2011,52
茨城,2011,0
栃木,2011,35
群馬,2011,61
埼玉,2011,12
千葉,2011,0
東京,2011,0
神奈川,2011,0
新潟,2011,56
富山,2011,16
石川,2011,10
福井,2011,4
山梨,2011,11
長野,2011,129
岐阜,2011,56
静岡,2011,19
愛知,2011,0
三重,2011,0
滋賀,2011,0
京都,2011,4
大阪,2011,0
兵庫,2011,2
奈良,2011,0
和歌山,2011,0
鳥取,2011,0
島根,2011,2
岡山,2011,0
広島,2011,12
山口,2011,0
計,2011,1667
北海道,2012,654
青森,2012,115
岩手,2012,254
宮城,2012,87
秋田,2012,318
山形,2012,283
福島,2012,294
茨城,2012,0
栃木,2012,44
群馬,2012,285
埼玉,2012,23
千葉,2012,0
東京,2012,4
神奈川,2012,0
新潟,2012,154
富山,2012,28
石川,2012,28
福井,2012,2
山梨,2012,35
長野,2012,392
岐阜,2012,106
静岡,2012,15
愛知,2012,0
三重,2012,0
滋賀,2012,1
京都,2012,2
大阪,2012,0
兵庫,2012,15
奈良,2012,0
和歌山,2012,1
鳥取,2012,16
島根,2012,4
岡山,2012,0
広島,2012,14
山口,2012,8
計,2012,3182
北海道,2013,540
青森,2013,76
岩手,2013,193
宮城,2013,22
秋田,2013,132
山形,2013,127
福島,2013,157
茨城,2013,0
栃木,2013,21
群馬,2013,72
埼玉,2013,6
千葉,2013,0
東京,2013,0
神奈川,2013,0
新潟,2013,85
富山,2013,27
石川,2013,26
福井,2013,7
山梨,2013,13
長野,2013,113
岐阜,2013,77
静岡,2013,18
愛知,2013,0
三重,2013,0
滋賀,2013,0
京都,2013,19
大阪,2013,0
兵庫,2013,12
奈良,2013,0
和歌山,2013,0
鳥取,2013,4
島根,2013,2
岡山,2013,0
広島,2013,11
山口,2013,2
計,2013,1762
北海道,2014,555
青森,2014,72
岩手,2014,307
宮城,2014,75
秋田,2014,255
山形,2014,233
福島,2014,430
茨城,2014,0
栃木,2014,87
群馬,2014,257
埼玉,2014,18
千葉,2014,0
東京,2014,1
神奈川,2014,0
新潟,2014,205
富山,2014,94
石川,2014,68
福井,2014,154
山梨,2014,11
長野,2014,656
岐阜,2014,347
静岡,2014,20
愛知,2014,0
三重,2014,0
滋賀,2014,0
京都,2014,24
大阪,2014,0
兵庫,2014,30
奈良,2014,0
和歌山,2014,0
鳥取,2014,26
島根,2014,14
岡山,2014,1
広島,2014,15
山口,2014,6
計,2014,3961
北海道,2015,641
青森,2015,99
岩手,2015,115
宮城,2015,33
秋田,2015,106
山形,2015,115
福島,2015,136
茨城,2015,0
栃木,2015,23
群馬,2015,75
埼玉,2015,4
千葉,2015,0
東京,2015,5
神奈川,2015,0
新潟,2015,113
富山,2015,35
石川,2015,35
福井,2015,36
山梨,2015,7
長野,2015,120
岐阜,2015,74
静岡,2015,19
愛知,2015,0
三重,2015,0
滋賀,2015,0
京都,2015,41
大阪,2015,0
兵庫,2015,18
奈良,2015,0
和歌山,2015,0
鳥取,2015,2
島根,2015,4
岡山,2015,0
広島,2015,8
山口,2015,1
計,2015,1865
北海道,2016,567
青森,2016,156
岩手,2016,340
宮城,2016,130
秋田,2016,476
山形,2016,262
福島,2016,343
茨城,2016,0
栃木,2016,57
群馬,2016,325
埼玉,2016,10
千葉,2016,0
東京,2016,4
神奈川,2016,2
新潟,2016,216
富山,2016,119
石川,2016,28
福井,2016,37
山梨,2016,17
長野,2016,224
岐阜,2016,86
静岡,2016,23
愛知,2016,0
三重,2016,0
滋賀,2016,0
京都,2016,68
大阪,2016,0
兵庫,2016,30
奈良,2016,0
和歌山,2016,0
鳥取,2016,71
島根,2016,56
岡山,2016,12
広島,2016,51
山口,2016,7
計,2016,3717
北海道,2017,774
青森,2017,261
岩手,2017,275
宮城,2017,56
秋田,2017,793
山形,2017,272
福島,2017,202
茨城,2017,0
栃木,2017,27
群馬,2017,174
埼玉,2017,5
千葉,2017,0
東京,2017,1
神奈川,2017,0
新潟,2017,255
富山,2017,44
石川,2017,52
福井,2017,80
山梨,2017,10
長野,2017,157
岐阜,2017,133
静岡,2017,30
愛知,2017,0
三重,2017,0
滋賀,2017,2
京都,2017,83
大阪,2017,0
兵庫,2017,33
奈良,2017,0
和歌山,2017,0
鳥取,2017,18
島根,2017,62
岡山,2017,2
広島,2017,32
山口,2017,10
計,2017,3843
北海道,2018,827
青森,2018,155
岩手,2018,246
宮城,2018,67
秋田,2018,408
山形,2018,210
福島,2018,251
茨城,2018,0
栃木,2018,40
群馬,2018,208
埼玉,2018,4
千葉,2018,0
東京,2018,1
神奈川,2018,2
新潟,2018,131
富山,2018,34
石川,2018,32
福井,2018,136
山梨,2018,22
長野,2018,165
岐阜,2018,97
静岡,2018,24
愛知,2018,0
三重,2018,0
滋賀,2018,0
京都,2018,103
大阪,2018,0
兵庫,2018,58
奈良,2018,0
和歌山,2018,0
鳥取,2018,50
島根,2018,113
岡山,2018,9
広島,2018,40
山口,2018,13
計,2018,3446
北海道,2019,756
青森,2019,245
岩手,2019,350
宮城,2019,213
秋田,2019,533
山形,2019,411
福島,2019,549
茨城,2019,0
栃木,2019,60
群馬,2019,377
埼玉,2019,31
千葉,2019,0
東京,2019,14
神奈川,2019,5
新潟,2019,556
富山,2019,172
石川,2019,118
福井,2019,193
山梨,2019,37
長野,2019,338
岐阜,2019,490
静岡,2019,20
愛知,2019,0
三重,2019,0
滋賀,2019,0
京都,2019,170
大阪,2019,0
兵庫,2019,120
奈良,2019,1
和歌山,2019,0
鳥取,2019,81
島根,2019,99
岡山,2019,11
広島,2019,68
山口,2019,21
計,2019,6039
北海道,2020,859
青森,2020,161
岩手,2020,432
宮城,2020,280
秋田,2020,607
山形,2020,656
福島,2020,852
茨城,2020,0
栃木,2020,89
群馬,2020,521
埼玉,2020,26
千葉,2020,0
東京,2020,12
神奈川,2020,2
新潟,2020,625
富山,2020,168
石川,2020,181
福井,2020,177
山梨,2020,41
長野,2020,316
岐阜,2020,209
静岡,2020,23
愛知,2020,3
三重,2020,2
滋賀,2020,0
京都,2020,132
大阪,2020,0
兵庫,2020,54
奈良,2020,0
和歌山,2020,0
鳥取,2020,76
島根,2020,267
岡山,2020,18
広島,2020,128
山口,2020,27
計,2020,6944
北海道,2021,819
青森,2021,216
岩手,2021,453
宮城,2021,128
秋田,2021,657
山形,2021,249
福島,2021,352
茨城,2021,0
栃木,2021,24
群馬,2021,244
埼玉,2021,6
千葉,2021,0
東京,2021,2
神奈川,2021,0
新潟,2021,175
富山,2021,50
石川,2021,44
福井,2021,108
山梨,2021,13
長野,2021,207
岐阜,2021,30
静岡,2021,28
愛知,2021,0
三重,2021,0
滋賀,2021,1
京都,2021,103
大阪,2021,1
兵庫,2021,55
奈良,2021,0
和歌山,2021,0
鳥取,2021,55
島根,2021,141
岡山,2021,17
広島,2021,70
山口,2021,46
計,2021,4294
北海道,2022,796
青森,2022,152
岩手,2022,384
宮城,2022,122
秋田,2022,397
山形,2022,310
福島,2022,404
茨城,2022,0
栃木,2022,37
群馬,2022,206
埼玉,2022,8
千葉,2022,0
東京,2022,7
神奈川,2022,2
新潟,2022,145
富山,2022,60
石川,2022,41
福井,2022,77
山梨,2022,27
長野,2022,177
岐阜,2022,51
静岡,2022,31
愛知,2022,0
三重,2022,0
滋賀,2022,0
京都,2022,114
大阪,2022,0
兵庫,2022,36
奈良,2022,0
和歌山,2022,0
鳥取,2022,23
島根,2022,68
岡山,2022,17
広島,2022,36
山口,2022,27
計,2022,3755
北海道,2023,1422
青森,2023,625
岩手,2023,804
宮城,2023,238
秋田,2023,2185
山形,2023,777
福島,2023,887
茨城,2023,0
栃木,2023,42
群馬,2023,344
埼玉,2023,19
千葉,2023,0
東京,2023,6
神奈川,2023,7
新潟,2023,432
富山,2023,135
石川,2023,68
福井,2023,124
山梨,2023,18
長野,2023,362
岐阜,2023,166
静岡,2023,26
愛知,2023,0
三重,2023,0
滋賀,2023,1
京都,2023,83
大阪,2023,0
兵庫,2023,34
奈良,2023,0
和歌山,2023,0
鳥取,2023,54
島根,2023,95
岡山,2023,9
広島,2023,84
山口,2023,52
計,2023,9099
北海道,2024,826
青森,2024,109
岩手,2024,426
宮城,2024,95
秋田,2024,382
山形,2024,240
福島,2024,509
茨城,2024,0
栃木,2024,30
群馬,2024,356
埼玉,2024,20
千葉,2024,0
東京,2024,15
神奈川,2024,3
新潟,2024,204
富山,2024,94
石川,2024,114
福井,2024,161
山梨,2024,17
長野,2024,325
岐阜,2024,189
静岡,2024,27
愛知,2024,1
三重,2024,6
滋賀,2024,3
京都,2024,280
大阪,2024,0
兵庫,2024,107
奈良,2024,1
和歌山,2024,0
鳥取,2024,111
島根,2024,283
岡山,2024,18
広島,2024,97
山口,2024,87
計,2024,5136
北海道,2025,617
青森,2025,764
岩手,2025,714
宮城,2025,130
秋田,2025,986
山形,2025,584
福島,2025,706
茨城,2025,0
栃木,2025,39
群馬,2025,301
埼玉,2025,16
千葉,2025,0
東京,2025,5
神奈川,2025,2
新潟,2025,304
富山,2025,84
石川,2025,49
福井,2025,82
山梨,2025,18
長野,2025,301
岐阜,2025,107
静岡,2025,34
愛知,2025,0
三重,2025,1
滋賀,2025,0
京都,2025,48
大阪,2025,0
兵庫,2025,32
奈良,2025,0
和歌山,2025,0
鳥取,2025,7
島根,2025,29
岡山,2025,2
広島,2025,12
山口,2025,9
計,2025,5983`;

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const data = {};
            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(',');
                const prefecture = row[0];
                const year = parseInt(row[1]);
                const count = parseInt(row[2]);
                if (!data[year]) data[year] = [];
                data[year].push({ prefecture, count });
            }
            return data;
        }

        const bearData = parseCSV(rawCsvData);

        // --- Map & DeckGL ---
        const { DeckGL, ColumnLayer } = deck;

        const deckgl = new DeckGL({
            container: 'map',
            mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
            initialViewState: {
                longitude: 138,
                latitude: 38,
                zoom: 5,
                pitch: 60,
                bearing: 0
            },
            controller: true,
            layers: []
        });

        // State
        let currentYear = 2023;
        let isPlaying = false;
        let playInterval;
        let playSpeed = 800; // ms per frame

        // Render Function
        function renderData(year) {
            const yearData = bearData[year];
            if (!yearData) return;

            yearData.sort((a, b) => b.count - a.count);

            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = '';
            let total = 0;
            const mapData = [];

            yearData.forEach(item => {
                if (item.prefecture === '計') {
                    total = item.count;
                    return;
                }

                const tr = document.createElement('tr');
                let countClass = 'count-low';
                if (item.count > 100) countClass = 'count-med';
                if (item.count > 300) countClass = 'count-high';

                tr.innerHTML = `<td>${item.prefecture}</td><td class="${countClass}">${item.count}</td>`;
                tbody.appendChild(tr);

                const coords = prefCoords[item.prefecture];
                if (coords && item.count > 0) {
                    mapData.push({
                        position: coords,
                        count: item.count,
                        prefecture: item.prefecture
                    });
                }
            });

            document.getElementById('total-incidents').innerText = total;
            document.getElementById('current-year').innerText = year;

            const columnLayer = new ColumnLayer({
                id: 'column-layer',
                data: mapData,
                diskResolution: 20, // Smoother cylinders
                radius: 15000,
                extruded: true,
                pickable: true,
                elevationScale: 100,
                getPosition: d => d.position,
                getFillColor: d => {
                    const c = d.count;
                    if (c > 300) return [255, 77, 77, 200]; // Soft Red
                    if (c > 100) return [255, 173, 51, 200]; // Soft Orange
                    return [51, 153, 255, 200]; // Soft Blue
                },
                getLineColor: [255, 255, 255],
                lineWidthMinPixels: 0,
                getElevation: d => d.count,
                autoHighlight: true,
                highlightColor: [255, 255, 255, 100],
                tooltip: true,
                transitions: {
                    getElevation: {
                        duration: 600,
                        easing: d3.easeCubicOut
                    },
                    getFillColor: {
                        duration: 300
                    }
                }
            });

            deckgl.setProps({
                layers: [columnLayer],
                getTooltip: ({ object }) => object && {
                    html: `<div style="font-family: 'Inter'; font-weight: bold;">${object.prefecture}</div><div>Incidents: ${object.count}</div>`,
                    style: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        color: '#fff',
                        fontSize: '12px',
                        padding: '8px',
                        borderRadius: '4px'
                    }
                }
            });
        }

        // Event Listeners
        const slider = document.getElementById('year-slider');
        const playBtn = document.getElementById('play-btn');
        const speedSlider = document.getElementById('speed-slider');
        const speedLabel = document.getElementById('speed-label');

        slider.addEventListener('input', (e) => {
            currentYear = parseInt(e.target.value);
            renderData(currentYear);
            if (isPlaying) stopPlay();
        });

        speedSlider.addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            // Map 1..20 to delay.
            // 1 = Slow (2000ms)
            // 20 = Fast (100ms)
            playSpeed = 2100 - (val * 100);

            // Update label
            const multiplier = (800 / playSpeed).toFixed(1);
            speedLabel.innerText = `${multiplier}x`;

            if (isPlaying) {
                stopPlay();
                startPlay();
            }
        });

        function startPlay() {
            isPlaying = true;
            playBtn.innerText = 'Pause';
            playBtn.style.background = '#e0e0e0';
            playBtn.style.color = '#000';

            playInterval = setInterval(() => {
                if (currentYear >= 2025) {
                    currentYear = 2008;
                } else {
                    currentYear++;
                }
                slider.value = currentYear;
                renderData(currentYear);
            }, playSpeed);
        }

        function stopPlay() {
            isPlaying = false;
            playBtn.innerText = 'Play';
            playBtn.style.background = '#fff';
            playBtn.style.color = '#000';
            clearInterval(playInterval);
        }

        playBtn.addEventListener('click', () => {
            if (isPlaying) {
                stopPlay();
            } else {
                startPlay();
            }
        });

        // Load d3-ease for smooth transitions
        const script = document.createElement('script');
        script.src = "https://d3js.org/d3-ease.v1.min.js";
        script.onload = () => {
            renderData(currentYear);
        };
        document.head.appendChild(script);

    </script>
</body>

</html>