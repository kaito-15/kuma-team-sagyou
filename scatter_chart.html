<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tohoku Bear Scatter Chart</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        h1 {
            margin-top: 20px;
            font-size: 2rem;
            text-align: center;
        }

        .charts-wrapper {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            width: 95%;
            max-width: 1800px;
            margin: 20px;
        }

        .chart-box {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 500px;
            background: #2a2a2a;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .bubble {
            fill-opacity: 0.7;
            stroke: #fff;
            stroke-width: 1px;
        }

        .bubble-label {
            font-weight: bold;
            fill: #fff;
            font-size: 12px;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        .year-label {
            font-size: 80px;
            font-weight: bold;
            fill: #444;
            position: absolute;
            bottom: 20px;
            right: 20px;
            pointer-events: none;
            opacity: 0.5;
        }

        .axis text {
            fill: #aaa;
            font-size: 12px;
        }

        .axis line,
        .axis path {
            stroke: #444;
        }

        .axis-label {
            fill: #ddd;
            font-size: 14px;
            font-weight: bold;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: #2a2a2a;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        button {
            background-color: #4d79ff;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #335ccc;
            color: white;
        }

        input[type=range] {
            width: 300px;
            cursor: pointer;
        }

        select {
            padding: 8px;
            border-radius: 5px;
            background: #444;
            color: white;
            border: none;
            cursor: pointer;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        /* Line Chart Specifics */
        .line-path {
            fill: none;
            stroke-width: 2px;
            opacity: 0.6;
        }

        .line-path.highlighted {
            opacity: 1;
            stroke-width: 3px;
        }

        .cursor-line {
            stroke: #fff;
            stroke-width: 1px;
            stroke-dasharray: 4 4;
            opacity: 0.5;
        }
    </style>
</head>

<body>

    <h1>東北地方 クマ被害相関図 & 被害件数推移</h1>

    <div class="controls">
        <button id="play-pause-btn">Pause</button>
        <input type="range" id="year-slider" min="0" max="100" value="0" step="1">
        <span id="current-year-display" style="font-weight: bold; min-width: 50px;"></span>
        <select id="speed-select">
            <option value="2000">Slow (2s)</option>
            <option value="1000" selected>Normal (1s)</option>
            <option value="500">Fast (0.5s)</option>
            <option value="200">Very Fast (0.2s)</option>
        </select>
        <button id="replay-btn">Replay</button>
    </div>

    <div class="charts-wrapper">
        <div id="scatter-container" class="chart-box"></div>
        <div id="line-container" class="chart-box"></div>
    </div>
    <div class="tooltip" id="tooltip"></div>

    <script>
        // Configuration
        const width = 800; // Adjusted for side-by-side
        const height = 500;
        const margin = { top: 40, right: 40, bottom: 60, left: 60 };
        let duration = 1000; // Animation duration per year in ms
        let isPlaying = false;
        let animationInterval = null;

        // --- Scatter Chart SVG ---
        const scatterSvg = d3.select("#scatter-container")
            .append("svg")
            .attr("viewBox", [0, 0, width, height])
            .attr("width", "100%")
            .attr("height", "100%");

        // --- Line Chart SVG ---
        const lineSvg = d3.select("#line-container")
            .append("svg")
            .attr("viewBox", [0, 0, width, height])
            .attr("width", "100%")
            .attr("height", "100%");

        // Color scale
        const color = d3.scaleOrdinal(d3.schemeTableau10);

        // Tohoku Prefectures
        const targetPrefectures = ["青森", "岩手", "宮城", "秋田", "山形", "福島"];

        // Load Data
        d3.csv("kuma_buna_all_long_intclean_fixed.csv").then(function (data) {

            // Parse and Filter Data
            const formattedData = [];
            data.forEach(d => {
                const year = +d["年度"];
                const name = d["都道府県"];
                const fruiting = d["結実"] === "" ? 0 : +d["結実"]; // X-axis
                const captured = d["捕獲総数"] === "" ? 0 : +d["捕獲総数"]; // Y-axis
                const incidents = d["件数"] === "" ? 0 : +d["件数"]; // Bubble Size & Line Chart Y-axis

                if (year && targetPrefectures.includes(name)) {
                    formattedData.push({ year, name, fruiting, captured, incidents });
                }
            });

            // Get all unique years and sort them
            const years = Array.from(new Set(formattedData.map(d => d.year))).sort((a, b) => a - b);

            // Setup Slider
            const slider = d3.select("#year-slider");
            slider.attr("max", years.length - 1);
            const yearDisplay = d3.select("#current-year-display");

            // Group data by year (for Scatter)
            const dataByYear = d3.group(formattedData, d => d.year);

            // Group data by prefecture (for Line Chart)
            const dataByPref = d3.group(formattedData, d => d.name);

            // --- SCATTER CHART SCALES ---
            const xScatter = d3.scaleLinear()
                .domain([0, 5]) // Fruiting index is 0-5
                .range([margin.left, width - margin.right]);

            const yScatter = d3.scaleLinear()
                .domain([0, d3.max(formattedData, d => d.captured) * 1.1]) // Max captured + padding
                .range([height - margin.bottom, margin.top]);

            const radius = d3.scaleSqrt()
                .domain([0, d3.max(formattedData, d => d.incidents)])
                .range([4, 40]); // Min 4px, Max 40px

            // --- LINE CHART SCALES ---
            const xLine = d3.scaleLinear()
                .domain(d3.extent(years))
                .range([margin.left, width - margin.right]);

            const yLine = d3.scaleLinear()
                .domain([0, d3.max(formattedData, d => d.incidents) * 1.1]) // Max incidents + padding
                .range([height - margin.bottom, margin.top]);

            // --- SCATTER AXES ---
            const xAxisScatter = g => g
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(xScatter).ticks(5))
                .call(g => g.select(".domain").remove())
                .call(g => g.append("text")
                    .attr("x", width - margin.right)
                    .attr("y", -10)
                    .attr("fill", "currentColor")
                    .attr("text-anchor", "end")
                    .attr("class", "axis-label")
                    .text("ブナ結実 (Fruiting Index) →"));

            const yAxisScatter = g => g
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(yScatter))
                .call(g => g.select(".domain").remove())
                .call(g => g.append("text")
                    .attr("x", 10)
                    .attr("y", margin.top)
                    .attr("fill", "currentColor")
                    .attr("text-anchor", "start")
                    .attr("class", "axis-label")
                    .text("↑ 捕獲総数 (Captured Bears)"));

            scatterSvg.append("g").attr("class", "axis").call(xAxisScatter);
            scatterSvg.append("g").attr("class", "axis").call(yAxisScatter);

            // --- LINE CHART AXES ---
            const xAxisLine = g => g
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(xLine).tickFormat(d3.format("d")))
                .call(g => g.select(".domain").remove())
                .call(g => g.append("text")
                    .attr("x", width - margin.right)
                    .attr("y", -10)
                    .attr("fill", "currentColor")
                    .attr("text-anchor", "end")
                    .attr("class", "axis-label")
                    .text("年度 (Year) →"));

            const yAxisLine = g => g
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(yLine))
                .call(g => g.select(".domain").remove())
                .call(g => g.append("text")
                    .attr("x", 10)
                    .attr("y", margin.top)
                    .attr("fill", "currentColor")
                    .attr("text-anchor", "start")
                    .attr("class", "axis-label")
                    .text("↑ 被害件数 (Incidents)"));

            lineSvg.append("g").attr("class", "axis").call(xAxisLine);
            lineSvg.append("g").attr("class", "axis").call(yAxisLine);

            // --- DRAW LINE CHART ---
            const line = d3.line()
                .x(d => xLine(d.year))
                .y(d => yLine(d.incidents));

            const linePaths = lineSvg.append("g")
                .selectAll("path")
                .data(targetPrefectures)
                .join("path")
                .attr("class", "line-path")
                .attr("d", pref => line(dataByPref.get(pref).sort((a, b) => a.year - b.year)))
                .attr("stroke", pref => color(pref))
                .on("mouseover", function (event, pref) {
                    d3.selectAll(".line-path").style("opacity", 0.2);
                    d3.select(this).style("opacity", 1).style("stroke-width", "4px");

                    // Highlight bubble too
                    d3.selectAll(".bubble").style("opacity", 0.2);
                    d3.selectAll(`.bubble-${pref}`).style("opacity", 1);

                    tooltip.style("opacity", 1)
                        .html(`<strong>${pref}</strong>`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function () {
                    d3.selectAll(".line-path").style("opacity", 0.6).style("stroke-width", "2px");
                    d3.selectAll(".bubble").style("opacity", 0.7);
                    tooltip.style("opacity", 0);
                });

            // Cursor Line for Line Chart
            const cursorLine = lineSvg.append("line")
                .attr("class", "cursor-line")
                .attr("y1", margin.top)
                .attr("y2", height - margin.bottom)
                .attr("opacity", 0);

            // --- SCATTER ELEMENTS ---
            const yearLabel = scatterSvg.append("text")
                .attr("class", "year-label")
                .attr("text-anchor", "end")
                .attr("x", width - 40)
                .attr("y", height - 40)
                .text(years[0]);

            let bubbles = scatterSvg.append("g").selectAll("circle");
            let labels = scatterSvg.append("g").selectAll("text");
            const tooltip = d3.select("#tooltip");

            let yearIndex = 0;

            function update(year, transitionDuration = duration) {
                const yearData = dataByYear.get(year) || [];

                // Update Slider and Display
                slider.property("value", years.indexOf(year));
                yearDisplay.text(year);

                // Update Year Label
                yearLabel.text(year);

                // Update Cursor Line
                cursorLine
                    .attr("x1", xLine(year))
                    .attr("x2", xLine(year))
                    .attr("opacity", 1);

                // Bubbles
                bubbles = bubbles.data(yearData, d => d.name)
                    .join(
                        enter => enter.append("circle")
                            .attr("class", d => `bubble bubble-${d.name}`)
                            .attr("fill", d => color(d.name))
                            .attr("cx", d => xScatter(d.fruiting))
                            .attr("cy", d => yScatter(d.captured))
                            .attr("r", d => radius(d.incidents))
                            .attr("opacity", 0)
                            .call(enter => enter.transition().duration(transitionDuration).attr("opacity", 0.7))
                            .on("mouseover", function (event, d) {
                                tooltip.style("opacity", 1)
                                    .html(`<strong>${d.name}</strong><br>結実: ${d.fruiting}<br>捕獲: ${d.captured}<br>被害: ${d.incidents}`)
                                    .style("left", (event.pageX + 10) + "px")
                                    .style("top", (event.pageY - 28) + "px");

                                // Highlight line
                                d3.selectAll(".line-path").style("opacity", 0.2);
                                d3.selectAll(".line-path").filter(p => p === d.name).style("opacity", 1).style("stroke-width", "4px");
                            })
                            .on("mouseout", function () {
                                tooltip.style("opacity", 0);
                                d3.selectAll(".line-path").style("opacity", 0.6).style("stroke-width", "2px");
                            }),
                        update => update.transition().duration(transitionDuration).ease(d3.easeLinear)
                            .attr("cx", d => xScatter(d.fruiting))
                            .attr("cy", d => yScatter(d.captured))
                            .attr("r", d => radius(d.incidents))
                            .attr("opacity", 0.7),
                        exit => exit.transition().duration(transitionDuration).attr("opacity", 0).remove()
                    );

                // Labels
                labels = labels.data(yearData, d => d.name)
                    .join(
                        enter => enter.append("text")
                            .attr("class", "bubble-label")
                            .text(d => d.name)
                            .attr("x", d => xScatter(d.fruiting))
                            .attr("y", d => yScatter(d.captured))
                            .attr("opacity", 0)
                            .call(enter => enter.transition().duration(transitionDuration).attr("opacity", 1)),
                        update => update.transition().duration(transitionDuration).ease(d3.easeLinear)
                            .attr("x", d => xScatter(d.fruiting))
                            .attr("y", d => yScatter(d.captured))
                            .attr("opacity", 1),
                        exit => exit.transition().duration(transitionDuration).attr("opacity", 0).remove()
                    );
            }

            function startAnimationLoop() {
                if (animationInterval) clearInterval(animationInterval);
                isPlaying = true;
                d3.select("#play-pause-btn").text("Pause");

                animationInterval = setInterval(() => {
                    yearIndex++;
                    if (yearIndex >= years.length) {
                        clearInterval(animationInterval);
                        isPlaying = false;
                        d3.select("#play-pause-btn").text("Replay");
                        return;
                    }
                    update(years[yearIndex]);
                }, duration);
            }

            function pauseAnimation() {
                if (animationInterval) clearInterval(animationInterval);
                isPlaying = false;
                d3.select("#play-pause-btn").text("Play");
            }

            function togglePlay() {
                if (isPlaying) {
                    pauseAnimation();
                } else {
                    if (yearIndex >= years.length - 1) {
                        yearIndex = 0; // Restart if at end
                        update(years[yearIndex], 0); // Instant update to start
                    }
                    startAnimationLoop();
                }
            }

            // Event Listeners
            d3.select("#play-pause-btn").on("click", togglePlay);

            d3.select("#replay-btn").on("click", () => {
                pauseAnimation();
                yearIndex = 0;
                update(years[0], 0);
                startAnimationLoop();
            });

            d3.select("#year-slider").on("input", function () {
                pauseAnimation();
                yearIndex = +this.value;
                update(years[yearIndex], 0); // Instant update
            });

            d3.select("#speed-select").on("change", function () {
                duration = +this.value;
                if (isPlaying) {
                    startAnimationLoop(); // Restart with new speed
                }
            });

            // Initial Render
            update(years[0], 0);

            // Start Animation after short delay
            setTimeout(() => {
                startAnimationLoop();
            }, 1000);

        }).catch(err => {
            console.error("Error loading CSV:", err);
            d3.select("#chart-container").append("p").style("color", "red").text("Error loading data. Check console.");
        });

    </script>
</body>

</html>