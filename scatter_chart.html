<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tohoku Bear Scatter Chart</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        h1 {
            margin-top: 20px;
            font-size: 2rem;
            text-align: center;
        }

        #chart-container {
            position: relative;
            width: 960px;
            height: 600px;
            background: #2a2a2a;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            margin: 20px;
        }

        .bubble {
            fill-opacity: 0.7;
            stroke: #fff;
            stroke-width: 1px;
        }

        .bubble-label {
            font-weight: bold;
            fill: #fff;
            font-size: 12px;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        .year-label {
            font-size: 100px;
            font-weight: bold;
            fill: #444;
            position: absolute;
            bottom: 40px;
            right: 40px;
            pointer-events: none;
            opacity: 0.5;
        }

        .axis text {
            fill: #aaa;
            font-size: 12px;
        }

        .axis line,
        .axis path {
            stroke: #444;
        }

        .axis-label {
            fill: #ddd;
            font-size: 14px;
            font-weight: bold;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: #2a2a2a;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        button {
            background-color: #4d79ff;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #335ccc;
        }

        input[type=range] {
            width: 300px;
            cursor: pointer;
        }

        select {
            padding: 8px;
            border-radius: 5px;
            background: #444;
            color: white;
            border: none;
            cursor: pointer;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
    </style>
</head>

<body>

    <h1>東北地方 クマ被害相関図 (縦:捕獲数 横:ブナ結実 バブル:被害件数)</h1>

    <div class="controls">
        <button id="play-pause-btn">Pause</button>
        <input type="range" id="year-slider" min="0" max="100" value="0" step="1">
        <span id="current-year-display" style="font-weight: bold; min-width: 50px;"></span>
        <select id="speed-select">
            <option value="2000">Slow (2s)</option>
            <option value="1000" selected>Normal (1s)</option>
            <option value="500">Fast (0.5s)</option>
            <option value="200">Very Fast (0.2s)</option>
        </select>
        <button id="replay-btn">Replay</button>
    </div>

    <div id="chart-container"></div>
    <div class="tooltip" id="tooltip"></div>

    <script>
        // Configuration
        const width = 960;
        const height = 600;
        const margin = { top: 40, right: 40, bottom: 60, left: 60 };
        let duration = 1000; // Animation duration per year in ms
        let isPlaying = false;
        let animationInterval = null;

        const svg = d3.select("#chart-container")
            .append("svg")
            .attr("viewBox", [0, 0, width, height])
            .attr("width", width)
            .attr("height", height);

        // Color scale
        const color = d3.scaleOrdinal(d3.schemeTableau10);

        // Tohoku Prefectures
        const targetPrefectures = ["青森", "岩手", "宮城", "秋田", "山形", "福島"];

        // Load Data
        d3.csv("kuma_buna_all_long_intclean_fixed.csv").then(function (data) {

            // Parse and Filter Data
            const formattedData = [];
            data.forEach(d => {
                const year = +d["年度"];
                const name = d["都道府県"];
                const fruiting = d["結実"] === "" ? 0 : +d["結実"]; // X-axis
                const captured = d["捕獲総数"] === "" ? 0 : +d["捕獲総数"]; // Y-axis
                const incidents = d["件数"] === "" ? 0 : +d["件数"]; // Bubble Size

                if (year && targetPrefectures.includes(name)) {
                    formattedData.push({ year, name, fruiting, captured, incidents });
                }
            });

            // Get all unique years and sort them
            const years = Array.from(new Set(formattedData.map(d => d.year))).sort((a, b) => a - b);

            // Setup Slider
            const slider = d3.select("#year-slider");
            slider.attr("max", years.length - 1);
            const yearDisplay = d3.select("#current-year-display");

            // Group data by year
            const dataByYear = d3.group(formattedData, d => d.year);

            // Scales
            const x = d3.scaleLinear()
                .domain([0, 5]) // Fruiting index is 0-5
                .range([margin.left, width - margin.right]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(formattedData, d => d.captured) * 1.1]) // Max captured + padding
                .range([height - margin.bottom, margin.top]);

            const radius = d3.scaleSqrt()
                .domain([0, d3.max(formattedData, d => d.incidents)])
                .range([4, 40]); // Min 4px, Max 40px

            // Axes
            const xAxis = g => g
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(5))
                .call(g => g.select(".domain").remove())
                .call(g => g.append("text")
                    .attr("x", width - margin.right)
                    .attr("y", -10)
                    .attr("fill", "currentColor")
                    .attr("text-anchor", "end")
                    .attr("class", "axis-label")
                    .text("ブナ結実 (Fruiting Index) →"));

            const yAxis = g => g
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(y))
                .call(g => g.select(".domain").remove())
                .call(g => g.append("text")
                    .attr("x", 10)
                    .attr("y", margin.top)
                    .attr("fill", "currentColor")
                    .attr("text-anchor", "start")
                    .attr("class", "axis-label")
                    .text("↑ 捕獲総数 (Captured Bears)"));

            // Append axes but keep them hidden initially
            const xAxisG = svg.append("g").attr("class", "axis").call(xAxis).attr("opacity", 0);
            const yAxisG = svg.append("g").attr("class", "axis").call(yAxis).attr("opacity", 0);

            // Initial Elements
            const yearLabel = svg.append("text")
                .attr("class", "year-label")
                .attr("text-anchor", "end")
                .attr("x", width - 40)
                .attr("y", height - 40)
                .text(years[0])
                .attr("opacity", 0); // Hidden initially

            let bubbles = svg.append("g").selectAll("circle");
            let labels = svg.append("g").selectAll("text");
            const tooltip = d3.select("#tooltip");

            let yearIndex = 0;

            function update(year, transitionDuration = duration) {
                const yearData = dataByYear.get(year) || [];

                // Update Slider and Display
                slider.property("value", years.indexOf(year));
                yearDisplay.text(year);

                // Update Year Label
                yearLabel.text(year);

                // Bubbles
                bubbles = bubbles.data(yearData, d => d.name)
                    .join(
                        enter => enter.append("circle")
                            .attr("class", "bubble")
                            .attr("fill", d => color(d.name))
                            .attr("cx", d => x(d.fruiting))
                            .attr("cy", d => y(d.captured))
                            .attr("r", d => radius(d.incidents))
                            .attr("opacity", 0) // Start hidden for sequential intro
                            .call(enter => enter.transition().duration(transitionDuration).attr("opacity", 0.7))
                            .on("mouseover", function (event, d) {
                                tooltip.style("opacity", 1)
                                    .html(`<strong>${d.name}</strong><br>結実: ${d.fruiting}<br>捕獲: ${d.captured}<br>被害: ${d.incidents}`)
                                    .style("left", (event.pageX + 10) + "px")
                                    .style("top", (event.pageY - 28) + "px");
                            })
                            .on("mouseout", function () {
                                tooltip.style("opacity", 0);
                            }),
                        update => update.transition().duration(transitionDuration).ease(d3.easeLinear)
                            .attr("cx", d => x(d.fruiting))
                            .attr("cy", d => y(d.captured))
                            .attr("r", d => radius(d.incidents))
                            .attr("opacity", 0.7),
                        exit => exit.transition().duration(transitionDuration).attr("opacity", 0).remove()
                    );

                // Labels
                labels = labels.data(yearData, d => d.name)
                    .join(
                        enter => enter.append("text")
                            .attr("class", "bubble-label")
                            .text(d => d.name)
                            .attr("x", d => x(d.fruiting))
                            .attr("y", d => y(d.captured))
                            .attr("opacity", 0)
                            .call(enter => enter.transition().duration(transitionDuration).attr("opacity", 1)),
                        update => update.transition().duration(transitionDuration).ease(d3.easeLinear)
                            .attr("x", d => x(d.fruiting))
                            .attr("y", d => y(d.captured))
                            .attr("opacity", 1),
                        exit => exit.transition().duration(transitionDuration).attr("opacity", 0).remove()
                    );
            }

            function startAnimationLoop() {
                if (animationInterval) clearInterval(animationInterval);
                isPlaying = true;
                d3.select("#play-pause-btn").text("Pause");

                animationInterval = setInterval(() => {
                    yearIndex++;
                    if (yearIndex >= years.length) {
                        clearInterval(animationInterval);
                        isPlaying = false;
                        d3.select("#play-pause-btn").text("Replay");
                        return;
                    }
                    update(years[yearIndex]);
                }, duration);
            }

            function pauseAnimation() {
                if (animationInterval) clearInterval(animationInterval);
                isPlaying = false;
                d3.select("#play-pause-btn").text("Play");
            }

            function togglePlay() {
                if (isPlaying) {
                    pauseAnimation();
                } else {
                    if (yearIndex >= years.length - 1) {
                        yearIndex = 0; // Restart if at end
                        update(years[yearIndex], 0); // Instant update to start
                    }
                    startAnimationLoop();
                }
            }

            // Sequential Intro
            function runIntroSequence() {
                // Reset everything
                yearIndex = 0;
                xAxisG.attr("opacity", 0);
                yAxisG.attr("opacity", 0);
                yearLabel.attr("opacity", 0);
                svg.selectAll(".bubble").remove();
                svg.selectAll(".bubble-label").remove();

                // 1. Show Y Axis
                yAxisG.transition().duration(1000).attr("opacity", 1)
                    .on("end", () => {
                        // 2. Show X Axis
                        xAxisG.transition().duration(1000).attr("opacity", 1)
                            .on("end", () => {
                                // 3. Show Bubbles (First Year)
                                update(years[0], 1000);
                                yearLabel.transition().duration(1000).attr("opacity", 0.5);

                                // 4. Start Animation after a short delay
                                setTimeout(() => {
                                    startAnimationLoop();
                                }, 1500);
                            });
                    });
            }

            // Event Listeners
            d3.select("#play-pause-btn").on("click", togglePlay);

            d3.select("#replay-btn").on("click", () => {
                pauseAnimation();
                runIntroSequence();
            });

            d3.select("#year-slider").on("input", function () {
                pauseAnimation();
                yearIndex = +this.value;
                update(years[yearIndex], 0); // Instant update
            });

            d3.select("#speed-select").on("change", function () {
                duration = +this.value;
                if (isPlaying) {
                    startAnimationLoop(); // Restart with new speed
                }
            });

            // Start the sequence on load
            runIntroSequence();

        }).catch(err => {
            console.error("Error loading CSV:", err);
            d3.select("#chart-container").append("p").style("color", "red").text("Error loading data. Check console.");
        });

    </script>
</body>

</html>